RewriteEngine On

# CRITICAL: Health check MUST be served first, before ANY other rules
# Railway healthcheck uses /healthz - must respond immediately without any processing
# This rule must come before all other rewrite rules
RewriteCond %{REQUEST_URI} ^/healthz$ [NC]
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^healthz$ - [L]

# Allow static files in /data/, /sitemaps/, and health check files to be served directly (before redirects)
# This prevents redirect loops for data, sitemap, and health check files
RewriteCond %{REQUEST_URI} ^/(data|sitemaps|healthz)/ [NC]
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Force HTTPS - redirect HTTP to HTTPS (must be first)
# Skip redirect for /data/ and /sitemaps/ files
# Note: Railway Edge terminates HTTPS, so we check X-Forwarded-Proto header instead
RewriteCond %{REQUEST_URI} !^/(data|sitemaps)/ [NC]
RewriteCond %{HTTPS} off
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Redirect non-www to www (canonical domain) - only for HTTPS
# Skip redirect for /data/ and /sitemaps/ files
# Note: Check X-Forwarded-Proto for Railway Edge HTTPS termination
RewriteCond %{REQUEST_URI} !^/(data|sitemaps)/ [NC]
RewriteCond %{HTTPS} on [OR]
RewriteCond %{HTTP:X-Forwarded-Proto} https
RewriteCond %{HTTP_HOST} ^floodbarrierpros\.com$ [NC]
RewriteRule ^(.*)$ https://www.floodbarrierpros.com/$1 [R=301,L]

# Route all requests to index.php if file/directory doesn't exist
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [QSA,L]
