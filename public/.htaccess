RewriteEngine On

# Allow static files in /data/, /sitemaps/, and health check files to be served directly (before redirects)
# This prevents redirect loops for data, sitemap, and health check files
RewriteCond %{REQUEST_URI} ^/(data|sitemaps|healthz)/ [NC]
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Also allow /healthz file to be served directly (Railway health check)
RewriteCond %{REQUEST_URI} ^/healthz$ [NC]
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Force HTTPS - redirect HTTP to HTTPS (must be first)
# Skip redirect for /data/ and /sitemaps/ files
RewriteCond %{REQUEST_URI} !^/(data|sitemaps)/ [NC]
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Redirect non-www to www (canonical domain) - only for HTTPS
# Skip redirect for /data/ and /sitemaps/ files
RewriteCond %{REQUEST_URI} !^/(data|sitemaps)/ [NC]
RewriteCond %{HTTPS} on
RewriteCond %{HTTP_HOST} ^floodbarrierpros\.com$ [NC]
RewriteRule ^(.*)$ https://www.floodbarrierpros.com/$1 [R=301,L]

# Route all requests to index.php if file/directory doesn't exist
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [QSA,L]
